{"version":3,"file":"app.min.js","sources":["../src/constants.ts","../src/promise-helpers.ts","../src/image-db.ts","../src/pubsub.ts","../src/sync/auth.ts","../src/view-state.ts","../src/filters/image-shader.ts","../src/filters/filter-transform.ts","../src/image-record.ts","../src/sync/google-drive.ts","../src/sync/sync.ts","../src/views/view.ts","../src/views/browse-view.ts","../src/camera-helper.ts","../src/views/capture-view.ts","../src/filters/named-filter.ts","../src/views/edit-view.ts","../src/views/upload-view.ts","../src/router.ts","../src/index.ts"],"sourcesContent":["/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nexport default {\n  CLIENT_ID: '151109002640-6hsca3c8lv5eutorkavk157rle1rjsgt.apps.googleusercontent.com',\n  DRIVE_FOLDER: 'Snapshot Photos',\n  IMAGE_TYPE: 'image/jpeg',\n  SUPPORTS_BGSYNC: 'SyncManager' in self,\n  SUPPORTS_IMAGE_CAPTURE: 'ImageCapture' in self,\n  SUPPORTS_MEDIA_DEVICES: 'mediaDevices' in navigator,\n  SYNC_FREQUENCY: 60000, // in milliseconds\n};\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nexport function dataUrlToArrayBuffer(dataURI: string): ArrayBuffer {\n  const byteString = atob(dataURI.split(',')[1]);\n  const ia = new Uint8Array(byteString.length);\n  for (let i = 0; i < byteString.length; i++) {\n      ia[i] = byteString.charCodeAt(i);\n  }\n  return ia.buffer as ArrayBuffer;\n}\n\nexport async function canvasToBlob(canvas: HTMLCanvasElement, type: string): Promise<Blob> {\n  if (canvas.toBlob) {\n    const result: Promise<Blob> = new Promise((resolve) => {\n      canvas.toBlob((blob: Blob) => resolve(blob), type);\n    });\n    return result;\n  } else {\n    const dataURL = canvas.toDataURL(type);\n    const buffer = dataUrlToArrayBuffer(dataURL);\n    return new Blob([buffer], {type});\n  }\n}\n\nexport function blobToArrayBuffer(blob: Blob): Promise<ArrayBuffer> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.addEventListener('loadend', async (e: ProgressEvent) => {\n      resolve(reader.result);\n    });\n    reader.addEventListener('error', reject);\n    reader.readAsArrayBuffer(blob);\n  });\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport {blobToArrayBuffer} from './promise-helpers';\n\nconst DB_VERSION = 4;\n\nexport interface IListRecord {\n  id: number | null;\n  guid: string;\n\n  originalId: number | null;\n  editedId: number | null;\n  thumbnailId: number | null;\n\n  transform: INumDict | null;\n\n  localFilterChanges: boolean;\n  localImageChanges: boolean;\n  lastSyncVersion: number;\n}\n\ninterface IMediaRecord {\n  media: ArrayBuffer;\n  type: string;\n}\n\nexport interface ISyncRecord {\n  id: number;\n  guid: string;\n  upload: boolean;\n  includeMedia: boolean;\n}\n\nclass ImageDB {\n  private dbPromise: Promise<IDBDatabase>;\n  private dbResolve: (value: IDBDatabase) => void;\n  private dbReject: (reason: any) => void;\n\n  constructor() {\n    const request = indexedDB.open('image-db', DB_VERSION);\n\n    this.dbPromise = new Promise((resolve, reject) => {\n      this.dbResolve = resolve;\n      this.dbReject = reject;\n\n      request.onerror = (reason) => this.dbReject(reason);\n      request.onupgradeneeded = (event) => this.createObjectStore(event);\n      request.onsuccess = (event) => this.dbOpened(request);\n    });\n  }\n\n  /**\n   * Store an image record in the database. If the `id` property of the\n   * record is not set, this will create a new entry. Returns the ID of the\n   * record.\n   */\n  storeRecord(record: IListRecord): Promise<number> {\n    if (record.id === null) {\n      delete record.id;\n    }\n    const promise: Promise<number> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['list'], 'readwrite');\n        const put = transaction.objectStore('list').put(record);\n\n        put.onsuccess = (event) => resolve(put.result);\n        put.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  retrieveRecord(id: number): Promise<IListRecord> {\n    const promise: Promise<IListRecord> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['list'], 'readonly');\n        const get = transaction.objectStore('list').get(id);\n\n        get.onsuccess = (event) => resolve(get.result);\n        get.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  deleteRecord(id: number, mediaIds: number[] = []): Promise<void> {\n    const promise: Promise<void> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['list', 'media'], 'readwrite');\n\n        for (const mediaId of mediaIds) {\n          transaction.objectStore('media').delete(mediaId);\n        }\n        transaction.objectStore('list').delete(id);\n\n        transaction.oncomplete = () => resolve();\n        transaction.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  async storeMedia(media: Blob, id?: number): Promise<number> {\n    const buffer = await blobToArrayBuffer(media);\n    const record = {\n      media: buffer,\n      type: media.type,\n    };\n    const promise: Promise<number> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['media'], 'readwrite');\n        const put = transaction.objectStore('media').put(record, id);\n\n        put.onsuccess = (event) => resolve(put.result);\n        put.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  retrieveMedia(id: number): Promise<Blob> {\n    const promise: Promise<Blob> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['media'], 'readonly');\n        const get = transaction.objectStore('media').get(id);\n\n        get.onsuccess = (event) => {\n          const record = get.result as IMediaRecord;\n          const blob = new Blob([record.media], {type: record.type});\n          resolve(blob);\n        };\n        get.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  addSync(data: ISyncRecord): Promise<void> {\n    const promise: Promise<void> = new Promise((resolve, reject) => {\n      if (!data.id && !data.guid) {\n        return reject('Neither local nor remote id was given');\n      }\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['sync'], 'readwrite');\n        const put = transaction.objectStore('sync').put(data);\n        put.onsuccess = () => resolve();\n        put.onerror = reject;\n      }).catch(reject);\n    });\n    return promise;\n  }\n\n  removeSync(id: number, guid: string): Promise<void> {\n    const promise: Promise<void> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        if (!id && !guid) {\n          return reject('Neither local nor remote id was given');\n        }\n        const key: IDBArrayKey = [id, guid];\n        const transaction = db.transaction(['sync'], 'readwrite');\n        transaction.objectStore('sync').delete(key);\n        transaction.oncomplete = () => resolve();\n        transaction.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  listSync(): Promise<ISyncRecord[]> {\n    const promise: Promise<ISyncRecord[]> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['sync'], 'readonly');\n        const open = transaction.objectStore('sync').openCursor();\n        const results: ISyncRecord[] = [];\n\n        open.onsuccess = (event) => {\n          const cursor = open.result as IDBCursorWithValue;\n\n          if (cursor) {\n            results.push(cursor.value);\n            cursor.continue();\n          } else {\n            resolve(results);\n          }\n        };\n        open.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  setMeta(key: string, value: any): Promise<void> {\n    const promise: Promise<void> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['metadata'], 'readwrite');\n        const put = transaction.objectStore('metadata').put(value, key);\n        put.onsuccess = () => resolve();\n        put.onerror = reject;\n      }).catch(reject);\n    });\n    return promise;\n  }\n\n  getMeta(key: string): Promise<any> {\n    const promise: Promise<any> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['metadata'], 'readonly');\n        const get = transaction.objectStore('metadata').get(key);\n        get.onsuccess = () => resolve(get.result);\n        get.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  all(): Promise<IListRecord[]> {\n    const promise: Promise<IListRecord[]> = new Promise((resolve, reject) => {\n      this.dbPromise.then((db) => {\n        const transaction = db.transaction(['list'], 'readonly');\n        const open = transaction.objectStore('list').openCursor();\n        const results: IListRecord[] = [];\n\n        open.onsuccess = (event) => {\n          const cursor = open.result as IDBCursorWithValue;\n\n          if (cursor) {\n            results.push(cursor.value);\n            cursor.continue();\n          } else {\n            resolve(results);\n          }\n        };\n        open.onerror = reject;\n      }).catch(reject);\n    });\n\n    return promise;\n  }\n\n  private dbOpened(request: IDBOpenDBRequest) {\n    this.dbResolve(request.result);\n    this.dbPromise.then((db) => {\n      db.onerror = (reason) => this.error(reason);\n    });\n  }\n\n  private error(reason: Event) {\n    console.error(reason);\n  }\n\n  private createObjectStore(event: IDBVersionChangeEvent) {\n    const request: IDBOpenDBRequest = event.target as IDBOpenDBRequest;\n    const db: IDBDatabase = request.result;\n\n    if (event.oldVersion < 3) {\n      if (event.oldVersion !== 0) {\n        db.deleteObjectStore('images');\n      }\n\n      db.createObjectStore('media', {autoIncrement: true});\n      db.createObjectStore('list', {keyPath: 'id', autoIncrement: true});\n    }\n\n    if (event.oldVersion < 4) {\n      db.createObjectStore('metadata');\n      db.createObjectStore('sync', {keyPath: ['id', 'guid']});\n    }\n  }\n}\n\nexport const imageDB = new ImageDB();\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\ninterface IAction {\n  channel: string;\n  data?: any;\n}\n\ntype Handler = (action: IAction) => void;\n\nconst subscribers: Map<string, Set<Handler>> = new Map();\n\nconst pubsub = {\n  publish(action: IAction) {\n    if (subscribers.has(action.channel)) {\n      const handlers = subscribers.get(action.channel)!;\n      console.log(`[PUBSUB] ${action.channel}: ${handlers.size} handlers`);\n      for (const handler of handlers) {\n        handler(action);\n      }\n    }\n  },\n\n  subscribe(channel: string, handler: Handler) {\n    if (!subscribers.has(channel)) {\n      subscribers.set(channel, new Set());\n    }\n    subscribers.get(channel)!.add(handler);\n  },\n\n  unsubscribe(channel: string, handler: Handler) {\n    if (subscribers.has(channel)) {\n      const handlers = subscribers.get(channel)!;\n      if (handlers.has(handler)) {\n        handlers.delete(handler);\n      }\n    }\n  },\n};\n\nif (navigator.serviceWorker) {\n  navigator.serviceWorker.addEventListener('message', (event) => {\n    pubsub.publish(event.data);\n  });\n}\nexport default pubsub;\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from '../constants';\nimport {imageDB} from '../image-db';\nimport pubsub from '../pubsub';\n\nclass User {\n  id: string = '';\n  name: string = '';\n  imageURL: string = '';\n  token: string = '';\n  tokenExpiry: number = 0;\n}\n\nexport const user: User = new User();\n\nexport async function resume() {\n  const storedToken: string = await imageDB.getMeta('token');\n  const storedExpiry: number = await imageDB.getMeta('tokenExpiry');\n  if (storedToken && (storedExpiry * 1000) > Date.now()) {\n    return validate(storedToken);\n  }\n}\n\nexport function login() {\n  const url = new URL('https://accounts.google.com/o/oauth2/v2/auth');\n  url.searchParams.append('client_id', constants.CLIENT_ID);\n  url.searchParams.append('redirect_uri', `${location.origin}/oauth`);\n  url.searchParams.append('response_type', 'token');\n  url.searchParams.append('scope', 'profile https://www.googleapis.com/auth/drive');\n  window.location.replace(url.toString());\n}\n\nexport function logout() {\n  user.token = '';\n  pubsub.publish({channel: 'logout'});\n  imageDB.setMeta('token', '');\n  imageDB.setMeta('tokenExpiry', 0);\n}\n\nexport async function validate(accessToken: string): Promise<void> {\n  if (accessToken === '') {\n    return;\n  }\n  const response = await fetch(`https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=${accessToken}`);\n  if (!response.ok) {\n    return logout();\n  }\n  const json = await response.json();\n  if (json.aud === constants.CLIENT_ID) {\n    const profileResponse = await fetch(`https://www.googleapis.com/plus/v1/people/me?access_token=${accessToken}`);\n    const profile = await profileResponse.json();\n    user.id = profile.id;\n    user.name = profile.displayName;\n    user.imageURL = profile.image.url;\n    user.token = accessToken;\n    user.tokenExpiry = json.exp;\n    pubsub.publish({channel: 'login'});\n    await imageDB.setMeta('token', accessToken);\n    await imageDB.setMeta('tokenExpiry', json.exp);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filters/filter-transform';\n\nexport default class ViewState {\n  id?: number;\n  transform?: FilterTransform;\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nconst BASE_VERTEX_SHADER = `\nattribute vec2 position;\nattribute vec2 uv;\n\nvarying vec2 texCoords;\n\nvoid main() {\n  gl_Position = vec4(position, 0, 1.0);\n  texCoords = uv;\n}`;\n\nconst BASE_FRAGMENT_SHADER = `\nprecision highp float;\n\nvarying vec2 texCoords;\n\nuniform sampler2D textureSampler;\n\nvoid main() {\n  gl_FragColor = texture2D(textureSampler, texCoords);\n}`;\n\nconst POSITIONS = new Float32Array([-1, -1, -1, 1, 1, 1, 1, -1]);\nconst UVS = new Float32Array([0, 1, 0, 0, 1, 0, 1, 1]);\nconst INDEX = new Uint16Array([0, 1, 2, 0, 2, 3]);\n\nclass UniformInfo {\n  type: GLenum;\n  location: WebGLUniformLocation;\n}\n\nexport default class ImageShader {\n  canvas: HTMLCanvasElement;\n  context: WebGLRenderingContext;\n\n  private textureId: WebGLTexture;\n  private programId: WebGLProgram;\n  private vertShader: string;\n  private fragShader: string;\n\n  private uniformLocations: Map<string, UniformInfo>;\n  private dirtyProgram: boolean;\n\n  constructor() {\n    this.canvas = document.createElement('canvas');\n    const context = this.canvas.getContext('webgl');\n\n    if (context === null) {\n      throw new Error(`Couldn't get a WebGL context`);\n    }\n\n    const gl: WebGLRenderingContext = context as WebGLRenderingContext;\n    this.context = gl;\n    const textureId = gl.createTexture();\n\n    if (textureId === null) {\n      throw new Error('Error getting texture ID');\n    }\n\n    this.textureId = textureId;\n    this.programId = 0;\n\n    this.vertShader = BASE_VERTEX_SHADER;\n    this.fragShader = BASE_FRAGMENT_SHADER;\n\n    this.uniformLocations = new Map();\n\n    this.bindBuffers(INDEX, POSITIONS, UVS);\n\n    gl.clearColor(1, 1, 1, 1);\n\n    this.dirtyProgram = true;\n  }\n\n  setImage(image: HTMLImageElement | HTMLVideoElement | HTMLCanvasElement) {\n    const gl = this.context;\n    gl.activeTexture(gl.TEXTURE0);\n    gl.bindTexture(gl.TEXTURE_2D, this.textureId);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n    // gl.generateMipmap(gl.TEXTURE_2D);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n  }\n\n  setVertexShader(source: string) {\n    this.vertShader = source;\n    this.dirtyProgram = true;\n  }\n\n  setFragmentShader(source: string) {\n    this.fragShader = source;\n    this.dirtyProgram = true;\n  }\n\n  setUniform(name: string, value: any) {\n    const gl = this.context;\n\n    if (this.dirtyProgram) {\n      this.createProgram();\n    }\n\n    if (!this.uniformLocations.has(name)) {\n      console.warn(`Tried to set unknown uniform ${name}`);\n      return;\n    }\n\n    const info = this.uniformLocations.get(name)!;\n\n    switch (info.type) {\n      case gl.FLOAT:\n        gl.uniform1fv(info.location, [value]);\n        break;\n      case gl.FLOAT_VEC2:\n        gl.uniform2fv(info.location, value);\n        break;\n      case gl.FLOAT_VEC3:\n        gl.uniform3fv(info.location, value);\n        break;\n      case gl.FLOAT_VEC4:\n        gl.uniform4fv(info.location, value);\n        break;\n      case gl.BOOL:\n      case gl.INT:\n        gl.uniform1iv(info.location, [value]);\n        break;\n      case gl.BOOL_VEC2:\n      case gl.INT_VEC2:\n        gl.uniform2iv(info.location, value);\n        break;\n      case gl.BOOL_VEC3:\n      case gl.INT_VEC3:\n        gl.uniform3iv(info.location, value);\n        break;\n      case gl.BOOL_VEC4:\n      case gl.INT_VEC4:\n        gl.uniform4iv(info.location, value);\n        break;\n      default:\n        console.error(`Couldn't set uniform, unsupported type`);\n    }\n  }\n\n  render() {\n    const gl = this.context;\n\n    if (this.dirtyProgram) {\n      this.createProgram();\n    }\n\n    gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);\n    gl.flush();\n  }\n\n  private createProgram() {\n    const gl = this.context;\n\n    const vertexShaderId = this.compileShader(this.vertShader, gl.VERTEX_SHADER);\n    const fragmentShaderId = this.compileShader(this.fragShader, gl.FRAGMENT_SHADER);\n    const programId = gl.createProgram();\n    if (programId === null) {\n      throw new Error(`Couldn't get a program ID`);\n    }\n    this.programId = programId;\n    gl.attachShader(programId, vertexShaderId);\n    gl.attachShader(programId, fragmentShaderId);\n    gl.linkProgram(programId);\n    if (!gl.getProgramParameter(programId, gl.LINK_STATUS)) {\n      const info = gl.getProgramInfoLog(programId);\n      throw new Error('Could not link shader program. \\n\\n' + info);\n    }\n    gl.validateProgram(programId);\n    if (!gl.getProgramParameter(programId, gl.VALIDATE_STATUS)) {\n      const info = gl.getProgramInfoLog(programId);\n      throw new Error('Could not validate shader program. \\n\\n' + info);\n    }\n    gl.useProgram(programId);\n    this.uniformLocations = new Map();\n    this.getUniformLocations();\n\n    this.dirtyProgram = false;\n  }\n\n  private compileShader(source: string, type: number): WebGLShader {\n    const gl = this.context;\n    const shader = gl.createShader(type);\n\n    if (shader === null) {\n      throw new Error('Error creating shader');\n    }\n\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\n      throw new Error(`Couldn't compiler shader: ${gl.getShaderInfoLog(shader)}`);\n    }\n    return shader;\n  }\n\n  private getUniformLocations() {\n    const gl = this.context;\n    const numUniforms = gl.getProgramParameter(this.programId, gl.ACTIVE_UNIFORMS);\n    for (let i = 0; i < numUniforms; i++) {\n      const info = gl.getActiveUniform(this.programId, i);\n      if (info === null) {\n        throw new Error(`Couldn't get uniform info`);\n      }\n      const location = gl.getUniformLocation(this.programId, info.name);\n      if (location) {\n        this.uniformLocations.set(info.name, {type: info.type, location});\n      }\n    }\n  }\n\n  private bindBuffers(index: Uint16Array, positions: Float32Array, uvs: Float32Array) {\n    const gl = this.context;\n    this.bindIndicesBuffer(index);\n    this.bindAttributeBuffer(0, 2, positions);\n    this.bindAttributeBuffer(1, 2, uvs);\n    gl.enableVertexAttribArray(0);\n    gl.enableVertexAttribArray(1);\n  }\n\n  private bindAttributeBuffer(attributeNumber: number, size: number, data: Float32Array) {\n    const gl = this.context;\n    const id = gl.createBuffer();\n    gl.bindBuffer(gl.ARRAY_BUFFER, id);\n    gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);\n    gl.vertexAttribPointer(attributeNumber, size, gl.FLOAT, false, 0, 0);\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\n  }\n\n  private bindIndicesBuffer(data: Uint16Array) {\n    const gl = this.context;\n    const id = gl.createBuffer();\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, id);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, data, gl.STATIC_DRAW);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport fragmentShader from './filter-fragment-shader.glsl';\nimport ImageShader from './image-shader';\n\nconst shader = new ImageShader();\nshader.setFragmentShader(fragmentShader);\n\nconst random = (min: number, max: number): number => {\n  let result = Math.random();\n  result *= (max - min);\n  result += min;\n  return result;\n};\n\nexport default class FilterTransform {\n  static from(data: IStringDict | INumDict | null) {\n    const result = new FilterTransform();\n\n    if (data) {\n      result.saturation = Number(data.saturation) || result.saturation;\n      result.warmth = Number(data.warmth) || result.warmth;\n      result.sharpen = Number(data.sharpen) || result.sharpen;\n      result.blur = Number(data.blur) || result.blur;\n      result.brightness = Number(data.brightness) || result.brightness;\n      result.contrast = Number(data.contrast) || result.contrast;\n      result.grey = Number(data.grey) || result.grey;\n      result.vignette = Number(data.vignette) || result.vignette;\n    }\n\n    return result;\n  }\n\n  saturation: number;\n  warmth: number;\n  sharpen: number;\n  blur: number;\n  brightness: number;\n  contrast: number;\n  grey: number;\n  vignette: number;\n\n  constructor() {\n    this.saturation = 1;\n    this.warmth = 0;\n    this.sharpen = 0;\n    this.blur = 1;\n    this.brightness = 1;\n    this.contrast = 1;\n    this.grey = 0.5;\n    this.vignette = 2;\n  }\n\n  randomize() {\n    this.saturation = random(0, 2);\n    this.warmth = random(-0.08, 0.08);\n    this.sharpen = random(-2, 2);\n    this.blur = random(0.01, 4);\n    this.brightness = random(0, 2);\n    this.contrast = random(0, 2);\n    this.grey = random(0, 1);\n    this.vignette = random(0.2, 2);\n  }\n\n  apply(source: ImageSource, dest: HTMLCanvasElement, height?: number) {\n    let sourceWidth: number;\n    let sourceHeight: number;\n    let relativeSize = 1;\n\n    if (source instanceof HTMLImageElement) {\n      sourceWidth = source.naturalWidth;\n      sourceHeight = source.naturalHeight;\n    } else if (source instanceof HTMLVideoElement) {\n      sourceWidth = source.videoWidth;\n      sourceHeight = source.videoHeight;\n    } else {\n      sourceWidth = source.width;\n      sourceHeight = source.height;\n    }\n\n    if (height && height !== sourceHeight) {\n      const resized = document.createElement('canvas');\n      const aspectRatio = sourceWidth / sourceHeight;\n      resized.height = height * devicePixelRatio;\n      resized.width = resized.height * aspectRatio;\n      resized.getContext('2d')!.drawImage(source, 0, 0, resized.width, resized.height);\n      shader.setImage(resized);\n      relativeSize = resized.height / sourceHeight;\n      dest.width = resized.width;\n      dest.height = resized.height;\n    } else {\n      shader.setImage(source);\n      dest.width = sourceWidth;\n      dest.height = sourceHeight;\n    }\n\n    shader.canvas.width = dest.width;\n    shader.canvas.height = dest.height;\n    shader.setUniform('sourceSize', new Float32Array([1 / dest.width, 1 / dest.height]));\n\n    // Reduce the blur value relative to the size of the output\n    shader.setUniform('blur', relativeSize * this.blur);\n    shader.setUniform('brightness', this.brightness);\n    shader.setUniform('contrast', this.contrast);\n    shader.setUniform('grey', this.grey);\n    shader.setUniform('saturation', this.saturation);\n    shader.setUniform('sharpen', this.sharpen);\n    shader.setUniform('vignette', this.vignette);\n    shader.setUniform('warmth', this.warmth);\n    shader.render();\n\n    const context = dest.getContext('2d')!;\n    context.drawImage(\n      shader.canvas,\n      0, 0, shader.canvas.width, shader.canvas.height,\n      0, 0, dest.width, dest.height);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from './constants';\nimport FilterTransform from './filters/filter-transform';\nimport {IListRecord, imageDB} from './image-db';\nimport {canvasToBlob} from './promise-helpers';\n\nenum ImageState {\n  NOT_LOADED,  // Haven't looked for it in IndexedDB yet\n  LOADED,      // Version in memory is the same as in IDB\n  CHANGED,     // Version in memory is different from IDB\n  OUT_OF_DATE, // Version in memory does not reflect the original and/or transform\n}\n\nexport default class ImageRecord {\n  static async fromDatabase(id: number) {\n    const data = await imageDB.retrieveRecord(id);\n    return ImageRecord.fromListRecord(data);\n  }\n\n  static fromListRecord(data: IListRecord) {\n    const result = new ImageRecord();\n\n    result.id = data.id;\n    result.guid = data.guid;\n\n    result.originalState = ImageState.NOT_LOADED;\n    result.editedState = ImageState.NOT_LOADED;\n    result.thumbnailState = ImageState.NOT_LOADED;\n\n    result.originalId = data.originalId;\n    result.editedId = data.editedId;\n    result.thumbnailId = data.thumbnailId;\n\n    result.transform = FilterTransform.from(data.transform);\n\n    result.localImageChanges = data.localImageChanges;\n    result.localFilterChanges = data.localFilterChanges;\n    result.lastSyncVersion = data.lastSyncVersion;\n\n    return result;\n  }\n\n  static async getAll(): Promise<ImageRecord[]> {\n    const records = await imageDB.all();\n    const result: ImageRecord[] = [];\n\n    for (const record of records) {\n      result.push(ImageRecord.fromListRecord(record));\n    }\n\n    return result;\n  }\n\n  id: number | null;\n  guid: string;\n\n  originalState: ImageState;\n  editedState: ImageState;\n  thumbnailState: ImageState;\n\n  originalId: number | null;\n  editedId: number | null;\n  thumbnailId: number | null;\n\n  localImageChanges: boolean;\n  localFilterChanges: boolean;\n  lastSyncVersion: number;\n\n  private $transform: FilterTransform | null;\n\n  private originalCache: Blob | null;\n  private editedCache: Blob | null;\n  private thumbnailCache: Blob | null;\n\n  constructor() {\n    this.id = null;\n    this.guid = '';\n\n    this.originalState = ImageState.CHANGED;\n    this.editedState = ImageState.CHANGED;\n    this.thumbnailState = ImageState.CHANGED;\n\n    this.originalId = null;\n    this.editedId = null;\n    this.thumbnailId = null;\n\n    this.$transform = null;\n\n    this.localImageChanges = true;\n    this.localFilterChanges = true;\n    this.lastSyncVersion = -1;\n\n    this.originalCache = null;\n    this.editedCache = null;\n    this.thumbnailCache = null;\n  }\n\n  get transform(): FilterTransform | null {\n    return this.$transform;\n  }\n\n  set transform(value: FilterTransform | null) {\n    this.$transform = value;\n    this.editedState = ImageState.OUT_OF_DATE;\n    this.thumbnailState = ImageState.OUT_OF_DATE;\n    this.localFilterChanges = true;\n  }\n\n  async getOriginal(): Promise<Blob | null> {\n    if (this.originalId && this.originalState === ImageState.NOT_LOADED) {\n      this.originalCache = await imageDB.retrieveMedia(this.originalId);\n      this.originalState = ImageState.LOADED;\n    }\n\n    return this.originalCache;\n  }\n\n  async getEdited(): Promise<Blob | null> {\n    if (this.editedId && this.editedState === ImageState.NOT_LOADED) {\n      this.editedCache = await imageDB.retrieveMedia(this.editedId);\n      this.editedState = ImageState.LOADED;\n    }\n    if (!this.editedId || this.editedState === ImageState.OUT_OF_DATE) {\n      this.editedCache = await this.drawFiltered();\n      this.editedState = ImageState.CHANGED;\n    }\n    return this.editedCache;\n  }\n\n  async getThumbnail(): Promise<Blob | null> {\n    if (this.thumbnailId && this.thumbnailState === ImageState.NOT_LOADED) {\n      this.thumbnailCache = await imageDB.retrieveMedia(this.thumbnailId);\n      this.thumbnailState = ImageState.LOADED;\n    }\n    if (!this.thumbnailId || this.thumbnailState === ImageState.OUT_OF_DATE) {\n      this.thumbnailCache = await this.drawFiltered(200);\n      this.thumbnailState = ImageState.CHANGED;\n    }\n    return this.thumbnailCache;\n  }\n\n  setOriginal(media: Blob) {\n    this.originalCache = media;\n    this.originalState = ImageState.CHANGED;\n    this.editedState = ImageState.OUT_OF_DATE;\n    this.thumbnailState = ImageState.OUT_OF_DATE;\n    this.localImageChanges = true;\n  }\n\n  async delete() {\n    if (!this.id) {\n      return;\n    }\n    const mediaIds: number[] = [];\n    if (this.originalId) {\n      mediaIds.push(this.originalId);\n    }\n    if (this.editedId) {\n      mediaIds.push(this.editedId);\n    }\n    if (this.thumbnailId) {\n      mediaIds.push(this.thumbnailId);\n    }\n    return imageDB.deleteRecord(this.id, mediaIds);\n  }\n\n  async drawFiltered(height?: number): Promise<Blob | null> {\n    const original = await this.getOriginal();\n    const result: Promise<Blob | null> = new Promise((resolve, reject) => {\n      if (original) {\n        const source = document.createElement('img');\n        source.onload = () => {\n          if (this.transform) {\n            const canvas = document.createElement('canvas');\n            URL.revokeObjectURL(source.src);\n            this.transform.apply(source, canvas, height);\n            resolve(canvasToBlob(canvas, constants.IMAGE_TYPE));\n          } else {\n            resolve(null);\n          }\n        };\n        source.onerror = reject;\n        source.src = URL.createObjectURL(original);\n      }\n    });\n\n    return result;\n  }\n\n  async save(): Promise<void> {\n    if (this.originalState === ImageState.CHANGED && this.originalCache !== null) {\n      this.originalId = await imageDB.storeMedia(this.originalCache, this.originalId || undefined);\n    }\n\n    if (this.editedState === ImageState.OUT_OF_DATE) {\n      this.editedCache = await this.drawFiltered();\n      this.editedState = ImageState.CHANGED;\n    }\n\n    if (this.editedState === ImageState.CHANGED && this.editedCache !== null) {\n      this.editedId = await imageDB.storeMedia(this.editedCache, this.editedId || undefined);\n    }\n\n    if (this.thumbnailState === ImageState.OUT_OF_DATE) {\n      this.thumbnailCache = await this.drawFiltered(200);\n      this.thumbnailState = ImageState.CHANGED;\n    }\n\n    if (this.thumbnailState === ImageState.CHANGED && this.thumbnailCache !== null) {\n      this.thumbnailId = await imageDB.storeMedia(this.thumbnailCache, this.thumbnailId || undefined);\n    }\n\n    let transformRecord: INumDict = {};\n\n    if (this.$transform) {\n      transformRecord = {...this.$transform};\n    }\n\n    this.id = await imageDB.storeRecord({\n      editedId: this.editedId,\n      guid: this.guid,\n      id: this.id,\n      lastSyncVersion: this.lastSyncVersion,\n      localFilterChanges: this.localFilterChanges,\n      localImageChanges: this.localImageChanges,\n      originalId: this.originalId,\n      thumbnailId: this.thumbnailId,\n      transform: transformRecord,\n    });\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport {user, validate} from './auth';\n\nconst DRIVE_API = 'https://www.googleapis.com/drive/v3/';\nconst DRIVE_UPLOAD_API = 'https://www.googleapis.com/upload/drive/v3/';\nconst COMMON_FILE_FIELDS = 'kind,id,name,mimeType,appProperties,trashed,version,size';\n\nfunction makeURL(base: string, defaults: IStringDict, options?: IStringDict): string {\n  const url = new URL(base);\n  for (const key in defaults) {\n    url.searchParams.append(key, defaults[key]);\n  }\n  if (options) {\n    for (const key in options) {\n      url.searchParams.append(key, options[key]);\n    }\n  }\n  return url.toString();\n}\n\nasync function doFetch(url: string, init: RequestInit): Promise<Response> {\n  if (!user.token) {\n    throw new Error('Not logged in');\n  }\n  const response = await fetch(url, init);\n  if (!response.ok) {\n    if (response.status === 401 || response.status === 403) {\n      validate(user.token);\n    }\n    throw new Error(`Couldn't fetch Drive API result: ${response.statusText}`);\n  }\n  return response;\n}\n\nexport async function driveRequest(endpoint: string, options?: IStringDict, init: RequestInit = {}) {\n  const url = makeURL(`${DRIVE_API}${endpoint}`, {\n    access_token: user.token,\n  }, options);\n  const response = await doFetch(url, init);\n  return response.json();\n}\n\nasync function driveMediaRequest(endpoint: string, options?: IStringDict, init: RequestInit = {}) {\n  const url = makeURL(`${DRIVE_API}${endpoint}`, {\n    access_token: user.token,\n    alt: 'media',\n  }, options);\n  const response = await doFetch(url, init);\n  return response.blob();\n}\n\nasync function driveUploadRequest(endpoint: string, body: Blob) {\n  const url = makeURL(`${DRIVE_UPLOAD_API}${endpoint}`, {\n    access_token: user.token,\n    uploadType: 'media',\n  });\n  const response = await doFetch(url, {method: 'PATCH', body});\n  return response.json();\n}\n\nexport async function getFileMeta(fileId: string): Promise<DriveFile> {\n  return driveRequest(`files/${fileId}`, {fields: COMMON_FILE_FIELDS});\n}\n\nexport async function getFileContent(fileId: string): Promise<Blob | null> {\n  return driveMediaRequest(`files/${fileId}`);\n}\n\nexport async function createFileMeta(file: DriveFile): Promise<DriveFile> {\n  return driveRequest(`files`, {fields: COMMON_FILE_FIELDS}, {\n    body: JSON.stringify(file),\n    headers: {'Content-Type': 'application/json'},\n    method: 'POST',\n  });\n}\n\nexport async function updateFileMeta(file: DriveFile): Promise<DriveFile> {\n  // Only certain fields get written\n  const body: DriveFile = {\n    appProperties: file.appProperties,\n    mimeType: file.mimeType,\n    name: file.name,\n  };\n  return driveRequest(`files/${file.id}`, {fields: COMMON_FILE_FIELDS}, {\n    body: JSON.stringify(body),\n    headers: {'Content-Type': 'application/json'},\n    method: 'PATCH',\n  });\n}\n\nexport async function updateFileContent(fileId: string, body: Blob): Promise<DriveFile> {\n  return driveUploadRequest(`files/${fileId}`, body);\n}\n\nexport async function folderList(folderId: string): Promise<DriveFile[]> {\n  let result: DriveFile[] = [];\n  const request: IStringDict = {\n    corpus: 'user',\n    fields: `files(${COMMON_FILE_FIELDS})`,\n    q: `'${folderId}' in parents`,\n    spaces: 'drive',\n  };\n  let nextPageToken: string = '';\n\n  do {\n    if (nextPageToken) {\n      request.nextPageToken = nextPageToken;\n    }\n    const list: DriveFileList = await driveRequest('files', request);\n    result = result.concat(list.files);\n    nextPageToken = list.nextPageToken;\n  } while (nextPageToken);\n\n  return result;\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\n/*\n  NOTE: This file gets included by the service worker. To prevent the service\n  worker from transitively including a lot of code (particularly around WebGL)\n  that it doesn't really need, this file does NOT use the ImageRecord or\n  FilterTransform wrapper classes. It directly uses the database features\n  instead.\n\n  TODO: In the future it might be nice to make the split at a higher level of\n  abstraction, like having a service worker friendly `BaseImageRecord` or\n  something.\n*/\n\nimport constants from '../constants';\nimport {IListRecord, imageDB} from '../image-db';\nimport pubsub from '../pubsub';\nimport {user} from './auth';\nimport {createFileMeta, driveRequest, folderList, getFileContent,\n  updateFileContent, updateFileMeta} from './google-drive';\n\nlet snapshotFolder: DriveFile | null = null;\n\nexport enum ChangeType {\n  ADD,\n  REMOVE,\n  UPDATE,\n}\n\nexport interface IChangeEvent {\n  type: ChangeType;\n  id: number;\n}\n\n/*\n  # Structure of the drive folder\n\n  The drive folder backs up only two things - original photos and the filter\n  options. The filter is stored as app specific metadata inside the file. See\n  https://developers.google.com/drive/v3/reference/files#appProperties\n\n  So each image in the app is a single uploaded file. The edited/thumbnail\n  versions are created in-app (for now - video filtering may require some\n  sort of cloud-based process.)\n*/\n\nfunction syncStart() {\n  syncFiles();\n  setInterval(syncFiles, constants.SYNC_FREQUENCY + 1000);\n}\n\n// Don't want to start trying to sync from inside the service worker\nif ('window' in self) {\n  pubsub.subscribe('login', syncStart);\n}\n\nexport async function getSnapshotFolder(): Promise<DriveFile> {\n  if (snapshotFolder) {\n    return snapshotFolder;\n  }\n\n  const files: DriveFileList = await driveRequest('files', {\n    corpus: 'user',\n    q: `name = '${constants.DRIVE_FOLDER}' and 'root' in parents`,\n    spaces: 'drive',\n  });\n  if (files && files.files.length === 1) {\n    snapshotFolder = files.files[0];\n    return snapshotFolder;\n  }\n\n  // Folder doesn't exist, create it\n  const bodyOptions: DriveFile = {\n    mimeType: 'application/vnd.google-apps.folder',\n    name: constants.DRIVE_FOLDER,\n    parents: ['root'],\n  };\n  snapshotFolder = await createFileMeta(bodyOptions) as DriveFile;\n  return snapshotFolder;\n}\n\nexport async function syncFiles() {\n  if (!user.token) {\n    return;\n  }\n  const lastSyncTime: number = Number(await imageDB.getMeta('lastSyncTime'));\n  if (lastSyncTime + constants.SYNC_FREQUENCY > Date.now()) {\n    return;\n  }\n\n  let registration: ServiceWorkerRegistration | undefined;\n  if (constants.SUPPORTS_BGSYNC) {\n    registration = await navigator.serviceWorker.getRegistration();\n  }\n\n  // Get the remote list of files\n  const folder = await getSnapshotFolder();\n  const files = await folderList(folder.id!);\n  const remoteOnly: Map<string, DriveFile> = new Map();\n  const localOnly: Set<IListRecord> = new Set();\n  const links: Map<DriveFile, IListRecord> = new Map();\n  for (const file of files) {\n    if (!file.id) {\n      continue;\n    }\n    remoteOnly.set(file.id, file);\n  }\n  for (const record of await imageDB.all()) {\n    if (remoteOnly.has(record.guid)) {\n      links.set(remoteOnly.get(record.guid)!, record);\n      remoteOnly.delete(record.guid);\n    } else {\n      localOnly.add(record);\n    }\n  }\n\n  if (registration) {\n    // Going to use background sync\n    for (const remote of remoteOnly.values()) {\n      if (remote.trashed) {\n        continue;\n      }\n      imageDB.addSync({id: 0, guid: remote.id!, upload: false, includeMedia: true});\n    }\n\n    for (const local of localOnly) {\n      imageDB.addSync({id: local.id!, guid: '', upload: true, includeMedia: true});\n    }\n\n    for (const [remote, local] of links) {\n      if (remote.trashed) {\n        // Remote was deleted, delete local too\n        pubsub.publish({channel: 'sync', data: {type: ChangeType.REMOVE, id: local.id!}});\n        deleteLocal(local);\n      } else if (local.localFilterChanges || local.localImageChanges) {\n        imageDB.addSync({\n          guid: remote.id!,\n          id: local.id!,\n          includeMedia: local.localImageChanges,\n          upload: true,\n        });\n      } else if (local.lastSyncVersion < remote.version!) {\n        imageDB.addSync({id: local.id!, guid: remote.id!, upload: false, includeMedia: true});\n      }\n    }\n\n    registration.sync.register('sync');\n  } else {\n    // Using direct download\n    for (const remote of remoteOnly.values()) {\n      if (remote.trashed) {\n        continue;\n      }\n      downloadRemote(remote, true);\n    }\n\n    // Upload local only\n    for (const local of localOnly) {\n      uploadLocal(local, local.localImageChanges);\n    }\n\n    for (const [remote, local] of links) {\n      if (remote.trashed) {\n        // Remote was deleted, delete local too\n        pubsub.publish({channel: 'sync', data: {type: ChangeType.REMOVE, id: local.id!}});\n        deleteLocal(local);\n      } else if (local.localImageChanges || local.localFilterChanges) {\n        uploadLocal(local, local.localImageChanges, remote);\n      } else if (local.lastSyncVersion < remote.version!) {\n        downloadRemote(remote, true, local);\n      }\n    }\n  }\n\n  imageDB.setMeta('lastSyncTime', Date.now());\n}\n\nexport async function deleteLocal(local: IListRecord) {\n  const mediaIds: number[] = [];\n  if (local.originalId) {\n    mediaIds.push(local.originalId);\n  }\n  if (local.editedId) {\n    mediaIds.push(local.editedId);\n  }\n  if (local.thumbnailId) {\n    mediaIds.push(local.thumbnailId);\n  }\n  imageDB.deleteRecord(local.id!, mediaIds);\n}\n\nexport async function\ndownloadRemote(remote: DriveFile, includeMedia: boolean, local?: IListRecord): Promise<number | undefined> {\n  if (!remote.id) {\n    return;\n  }\n  // TODO: Only download the media if it actually changed - this function would\n  // be called for a simple filter change, too.\n  const original = await getFileContent(remote.id);\n\n  if (original) {\n    const record: IListRecord = local || {\n      editedId: null,\n      guid: '',\n      id: null,\n      lastSyncVersion: -1,\n      localFilterChanges: false,\n      localImageChanges: false,\n      originalId: null,\n      thumbnailId: null,\n      transform: {},\n    };\n    record.guid = remote.id;\n\n    if (remote.appProperties) {\n      const data = remote.appProperties;\n      const transform = record.transform || {};\n      transform.saturation = Number(data.saturation) || transform.saturation;\n      transform.warmth = Number(data.warmth) || transform.warmth;\n      transform.sharpen = Number(data.sharpen) || transform.sharpen;\n      transform.blur = Number(data.blur) || transform.blur;\n      transform.brightness = Number(data.brightness) || transform.brightness;\n      transform.contrast = Number(data.contrast) || transform.contrast;\n      transform.grey = Number(data.grey) || transform.grey;\n      transform.vignette = Number(data.vignette) || transform.vignette;\n      record.transform = transform;\n    }\n\n    record.localFilterChanges = false;\n    record.localImageChanges = false;\n    record.lastSyncVersion = remote.version!;\n    record.originalId = await imageDB.storeMedia(original);\n    await imageDB.storeRecord(record);\n    pubsub.publish({channel: 'sync', data: {type: ChangeType.ADD, id: record.id!}});\n    return record.id!;\n  } else {\n    console.log(`Could not fetch original image`);\n  }\n  return;\n}\n\nexport async function uploadLocal(local: IListRecord, includeMedia: boolean, remote?: DriveFile) {\n  if (!local.originalId) {\n    return;\n  }\n  const original = await imageDB.retrieveMedia(local.originalId);\n  if (!original) {\n    return;\n  }\n\n  if (!remote) {\n    const parent = await getSnapshotFolder();\n\n    if (!parent || !parent.id) {\n      return;\n    }\n\n    // Create the file record\n    remote = {\n      mimeType: original.type,\n      name: `${local.id}_${Date.now()}`,\n      parents: [parent.id],\n    };\n  }\n\n  // Set the metadata to be the transform values\n  if (local.transform) {\n    remote.appProperties = {};\n    for (const key in local.transform) {\n      remote.appProperties[key] = String(local.transform[key]);\n    }\n  }\n\n  if (remote.id) {\n    const result = await updateFileMeta(remote);\n    local.lastSyncVersion = result.version!;\n  } else {\n    const file = await createFileMeta(remote);\n    if (!file.id) {\n      return;\n    }\n    remote.id = file.id;\n    local.guid = file.id;\n  }\n\n  if (includeMedia) {\n    // Upload the data\n    const updated = await updateFileContent(remote.id, original);\n    local.lastSyncVersion = updated.version!;\n    local.localImageChanges = false;\n  }\n  local.localFilterChanges = false;\n  return imageDB.storeRecord(local);\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ViewState from '../view-state';\n\nexport default class View {\n  protected viewElement: HTMLElement;\n  private state?: ViewState;\n\n  constructor(viewElement: HTMLElement) {\n    this.viewElement = viewElement;\n  }\n\n  show(): void {\n    this.viewElement.classList.remove('hidden');\n  }\n\n  hide(): void {\n    this.viewElement.classList.add('hidden');\n  }\n\n  getState(): ViewState {\n    return this.state || new ViewState();\n  }\n\n  setState(state: ViewState) {\n    this.state = state;\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from '../constants';\nimport ImageRecord from '../image-record';\nimport pubsub from '../pubsub';\nimport router from '../router';\nimport {login, logout, user} from '../sync/auth';\nimport {ChangeType, IChangeEvent} from '../sync/sync';\nimport View from './view';\n\nexport default class BrowseView extends View {\n  private captureButton: HTMLButtonElement;\n  private uploadButton: HTMLButtonElement;\n  private loginButton: HTMLButtonElement;\n  private logoutButton: HTMLButtonElement;\n  private loginBar: HTMLElement;\n  private userName: HTMLSpanElement;\n  private userImage: HTMLImageElement;\n  private emptyListElement: HTMLElement;\n  private listElement: HTMLElement;\n  private thumbnails: Map<number, HTMLElement>;\n  private blobURLs: Set<string>;\n\n  constructor() {\n    super(document.getElementById('browse-view')!);\n\n    this.captureButton = document.getElementById('browse-capture-button') as HTMLButtonElement;\n    this.uploadButton = document.getElementById('browse-upload-button') as HTMLButtonElement;\n    this.loginButton = document.getElementById('login-button') as HTMLButtonElement;\n    this.logoutButton = document.getElementById('logout-button') as HTMLButtonElement;\n    this.loginBar = document.getElementById('login-bar')!;\n    this.userName = document.getElementById('user-name')!;\n    this.userImage = document.getElementById('user-image') as HTMLImageElement;\n    this.emptyListElement = document.getElementById('empty-browse-list')!;\n    this.listElement = document.getElementById('browse-list')!;\n\n    if (!constants.SUPPORTS_MEDIA_DEVICES) {\n      this.captureButton.classList.add('hidden');\n    }\n\n    this.captureButton.addEventListener('click', () => this.captureClick());\n    this.uploadButton.addEventListener('click', () => this.uploadClick());\n    this.loginButton.addEventListener('click', () => this.loginClick());\n    this.logoutButton.addEventListener('click', () => this.logoutClick());\n\n    this.thumbnails = new Map();\n    this.blobURLs = new Set();\n\n    pubsub.subscribe('login', () => this.authChanged());\n    pubsub.subscribe('logout', () => this.authChanged());\n    pubsub.subscribe('sync', (action) => this.syncHandler(action.data));\n  }\n\n  async show() {\n    const photos = await ImageRecord.getAll();\n\n    for (const record of photos) {\n      this.addThumbnail(record);\n    }\n\n    this.setListVisibility();\n\n    super.show();\n  }\n\n  hide() {\n    super.hide();\n    // TODO: Have a good think about this. The strategy here is to remove all\n    // child elements when we hide, because smaller DOM seems like a win for the\n    // rest of the app. But really we probably want a recycler instead...\n    while (this.listElement.hasChildNodes()) {\n      this.listElement.removeChild(this.listElement.lastChild!);\n    }\n    for (const url of this.blobURLs) {\n      URL.revokeObjectURL(url);\n    }\n    this.thumbnails.clear();\n    this.blobURLs.clear();\n  }\n\n  captureClick() {\n    router.visit('/capture');\n  }\n\n  uploadClick() {\n    router.visit('/upload');\n  }\n\n  loginClick() {\n    login();\n  }\n\n  logoutClick() {\n    logout();\n  }\n\n  authChanged() {\n    if (user.token === '') {\n      this.loginBar.classList.remove('is-logged-in');\n    } else {\n      this.loginBar.classList.add('is-logged-in');\n      this.userName.innerText = user.name;\n      this.userImage.src = user.imageURL;\n    }\n  }\n\n  private setListVisibility() {\n    if (this.thumbnails.size === 0) {\n      this.emptyListElement.classList.remove('hidden');\n      this.listElement.classList.add('hidden');\n    } else {\n      this.emptyListElement.classList.add('hidden');\n      this.listElement.classList.remove('hidden');\n    }\n  }\n\n  private async addThumbnail(record: ImageRecord) {\n    const thumb = document.createElement('div');\n    thumb.classList.add('element');\n    thumb.addEventListener('click', () => router.visit(`/edit/${record.id}`));\n\n    this.thumbnails.set(record.id!, thumb);\n\n    const blob = await record.getThumbnail();\n    if (blob) {\n      const url = URL.createObjectURL(blob);\n      const image = document.createElement('img');\n      image.src = url;\n      thumb.appendChild(image);\n      this.blobURLs.add(url);\n    } else {\n      // TODO: Handle this error condition\n    }\n    this.listElement.appendChild(thumb);\n  }\n\n  private async syncHandler(event: IChangeEvent) {\n    switch (event.type) {\n      case ChangeType.REMOVE:\n        if (this.thumbnails.has(event.id)) {\n          this.listElement.removeChild(this.thumbnails.get(event.id)!);\n          this.thumbnails.delete(event.id);\n        }\n        break;\n      case ChangeType.ADD:\n        this.addThumbnail(await ImageRecord.fromDatabase(event.id));\n        break;\n      case ChangeType.UPDATE:\n        // TODO: Should update the image in place, this is going to swap the order\n        if (this.thumbnails.has(event.id)) {\n          this.listElement.removeChild(this.thumbnails.get(event.id)!);\n        }\n        this.addThumbnail(await ImageRecord.fromDatabase(event.id));\n        break;\n    }\n    this.setListVisibility();\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport constants from './constants';\nimport {canvasToBlob} from './promise-helpers';\n\nconst streamConstraints: MediaStreamConstraints = {\n  video: {\n    deviceId: '',\n    facingMode: ['user', 'environment'],\n    height: {ideal: 1080},\n    width: {ideal: 1920},\n  },\n};\n\nlet supportedConstraints: MediaTrackSupportedConstraints = {};\n\nif (constants.SUPPORTS_MEDIA_DEVICES) {\n  supportedConstraints = navigator.mediaDevices.getSupportedConstraints();\n}\n\nexport default class CameraHelper {\n  flash: FillLightMode;\n\n  private stream: MediaStream | null;\n  private track: MediaStreamTrack | null;\n  private trackConstraints: MediaTrackSettings;\n  private photoCapabilities: PhotoCapabilities | null;\n\n  constructor() {\n    this.stream = null;\n    this.track = null;\n\n    this.photoCapabilities = null;\n    this.trackConstraints = {};\n\n    this.flash = 'off';\n  }\n\n  async getCameras() {\n    let devices: MediaDeviceInfo[] = [];\n\n    if (constants.SUPPORTS_MEDIA_DEVICES) {\n      devices = await navigator.mediaDevices.enumerateDevices();\n      devices = devices.filter((device) => device.kind === 'videoinput');\n    }\n\n    return devices;\n  }\n\n  async takePhoto(video: HTMLVideoElement): Promise<Blob | null> {\n    if (!constants.SUPPORTS_MEDIA_DEVICES) {\n      return null;\n    }\n\n    if (constants.SUPPORTS_IMAGE_CAPTURE) {\n      const stream = video.srcObject;\n\n      if (!stream) {\n        return null;\n      }\n\n      const track = stream.getVideoTracks()[0];\n      const capture = new ImageCapture(track);\n      const settings: PhotoSettings = {};\n\n      if (this.photoCapabilities) {\n        if (this.photoCapabilities.fillLightMode.includes(this.flash)) {\n          settings.fillLightMode = this.flash;\n        }\n      }\n\n      return await capture.takePhoto(settings);\n    } else {\n      const canvas = document.createElement('canvas');\n      const context = canvas.getContext('2d')!;\n      canvas.width = video.videoWidth;\n      canvas.height = video.videoHeight;\n      context.drawImage(video, 0, 0);\n\n      return await canvasToBlob(canvas, constants.IMAGE_TYPE);\n    }\n  }\n\n  stopStream() {\n    if (this.stream) {\n      for (const track of this.stream.getVideoTracks()) {\n        track.stop();\n      }\n    }\n  }\n\n  async startStream(deviceId: string) {\n    this.stopStream();\n\n    (streamConstraints.video as MediaTrackConstraints).deviceId = deviceId;\n\n    const stream = await navigator.mediaDevices.getUserMedia(streamConstraints);\n    this.stream = stream;\n    this.track = stream.getVideoTracks()[0];\n\n    if (constants.SUPPORTS_IMAGE_CAPTURE) {\n      const capture = new ImageCapture(this.track);\n      this.photoCapabilities = await capture.getPhotoCapabilities();\n    }\n\n    this.trackConstraints = {};\n    return stream;\n  }\n\n  getPhotoCapabilities(): {flash: FillLightMode[], redEyeReduction: boolean} {\n    if (this.photoCapabilities) {\n      return {\n        flash: this.photoCapabilities.fillLightMode,\n        redEyeReduction: this.photoCapabilities.redEyeReduction === 'controllable',\n      };\n    }\n\n    return {\n      flash: [],\n      redEyeReduction: false,\n    };\n  }\n\n  getSettings(): MediaTrackSettings {\n    if (!this.track || !this.track.getSettings) {\n      return {};\n    }\n    return this.track.getSettings();\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport CameraHelper from '../camera-helper';\nimport ImageRecord from '../image-record';\nimport router from '../router';\nimport View from './view';\n\nexport default class CaptureView extends View {\n  private videoElement: HTMLVideoElement;\n  private videoElement2: HTMLVideoElement;\n  private takePhotoButton: HTMLButtonElement;\n  private cameraChooseButton: HTMLButtonElement;\n  private mirrorButton: HTMLButtonElement;\n  private flashButton: HTMLButtonElement;\n  private closeButton: HTMLButtonElement;\n\n  private cameraHelper: CameraHelper;\n\n  private devicesPromise: Promise<MediaDeviceInfo[]>;\n  private currentDevice: MediaDeviceInfo | null;\n\n  constructor() {\n    super(document.getElementById('capture-view')!);\n    this.videoElement = this.viewElement.querySelector('video#preview')! as HTMLVideoElement;\n    this.videoElement2 = this.viewElement.querySelector('video#preview2')! as HTMLVideoElement;\n    this.takePhotoButton = document.getElementById('capture-button')! as HTMLButtonElement;\n    this.cameraChooseButton = document.getElementById('camera-choose-button')! as HTMLButtonElement;\n    this.mirrorButton = document.getElementById('capture-mirror-button')! as HTMLButtonElement;\n    this.flashButton = document.getElementById('capture-flash-button')! as HTMLButtonElement;\n    this.closeButton = document.getElementById('capture-view-close')! as HTMLButtonElement;\n\n    this.videoElement2.classList.add('hidden');\n\n    this.cameraHelper = new CameraHelper();\n\n    this.takePhotoButton.addEventListener('click', () => this.takePhoto());\n    this.cameraChooseButton.addEventListener('click', () => this.toggleCameraChooser());\n    this.mirrorButton.addEventListener('click', () => this.toggleMirror());\n    this.flashButton.addEventListener('click', () => this.toggleFlash());\n    this.closeButton.addEventListener('click', () => this.close());\n\n    this.devicesPromise = this.getDevices();\n    this.currentDevice = null;\n  }\n\n  show() {\n    this.devicesPromise.then((devices) => {\n      this.chooseCamera(devices[0]);\n    });\n    super.show();\n  }\n\n  hide() {\n    this.cameraHelper.stopStream();\n    this.videoElement.pause();\n    super.hide();\n  }\n\n  async getDevices() {\n    const cameras = await this.cameraHelper.getCameras();\n\n    if (cameras.length < 2) {\n      this.cameraChooseButton.classList.add('hidden');\n    } else {\n      this.cameraChooseButton.classList.remove('hidden');\n    }\n\n    return cameras;\n  }\n\n  async takePhoto() {\n    const blob = await this.cameraHelper.takePhoto(this.videoElement);\n    if (blob) {\n      this.storeResult(blob);\n    } else {\n      // TODO: This is an unhandled error condition\n    }\n  }\n\n  async toggleCameraChooser() {\n    // Four possible cases\n    // 1. No camera! This view shouldn't even come up, we need a fallback UI\n    // 2. One camera. Button should be hidden.\n    // 3. Two cameras. Clicking button is a simple toggle.\n    // 4. Three or more cameras. Present a chooser with the names and/or\n    //    features of the cameras.\n    // TODO: Need to change the button to reflect the kind of camera that will\n    // be selected.\n    // TODO: Need to decide what happens if we change camera while recording\n    const devices = await this.devicesPromise;\n    if (devices.length < 2) {\n      return;\n    }\n\n    if (this.currentDevice) {\n      const currentIndex = devices.indexOf(this.currentDevice);\n\n      // TODO: Should show chooser for many devices, not just cycle\n      this.chooseCamera(devices[(currentIndex + 1) % devices.length]);\n    } else {\n      this.chooseCamera(devices[0]);\n    }\n  }\n\n  close() {\n    router.visit(`/browse`);\n  }\n\n  private async chooseCamera(camera: MediaDeviceInfo) {\n    this.currentDevice = camera;\n    await this.startStream(this.currentDevice.deviceId);\n    const photoCapabilities = this.cameraHelper.getPhotoCapabilities();\n    const settings = this.cameraHelper.getSettings();\n    if (settings.facingMode === 'user') {\n      this.videoElement.classList.add('mirror');\n    } else {\n      this.videoElement.classList.remove('mirror');\n    }\n    this.flashButton.classList.remove('flash-flash', 'flash-off', 'flash-auto');\n    this.flashButton.classList.add(`flash-${this.cameraHelper.flash}`);\n    if (photoCapabilities.flash.length > 0) {\n      this.flashButton.classList.remove('hidden');\n    } else {\n      this.flashButton.classList.add('hidden');\n    }\n  }\n\n  private async storeResult(blob: Blob) {\n    const record = new ImageRecord();\n    record.setOriginal(blob);\n    await record.save();\n    router.visit(`/edit/${record.id}`);\n  }\n\n  private async startStream(deviceId: string) {\n    const stream = await this.cameraHelper.startStream(deviceId);\n    this.videoElement2.srcObject = stream;\n    return new Promise((resolve) => {\n      this.videoElement2.onloadedmetadata = () => {\n        const temp = this.videoElement;\n        this.videoElement = this.videoElement2;\n        this.videoElement2 = temp;\n        this.videoElement.play();\n        this.videoElement.classList.remove('hidden');\n        this.videoElement2.classList.add('hidden');\n        this.videoElement2.pause();\n        resolve();\n      };\n    });\n  }\n\n  private toggleMirror() {\n    this.videoElement.classList.toggle('mirror');\n  }\n\n  private toggleFlash() {\n    this.flashButton.classList.remove(`flash-${this.cameraHelper.flash}`);\n    const photoCapabilities = this.cameraHelper.getPhotoCapabilities();\n    let index = photoCapabilities.flash.indexOf(this.cameraHelper.flash);\n    index = (index + 1) % photoCapabilities.flash.length;\n    this.cameraHelper.flash = photoCapabilities.flash[index];\n    this.flashButton.classList.add(`flash-${this.cameraHelper.flash}`);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from './filter-transform';\n\nexport class NamedFilter {\n  name: string;\n  values: FilterTransform;\n\n  constructor() {\n    this.name = '';\n    this.values = new FilterTransform();\n  }\n}\n\nexport const namedFilters: NamedFilter[] = [\n  {\n    name: 'Grimsby',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Slough',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Burnley',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Carlisle',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Stevenage',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Hull',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Swansea',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Luton',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Glasgow',\n    values: new FilterTransform(),\n  },\n  {\n    name: 'Dull',\n    values: new FilterTransform(),\n  },\n];\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport FilterTransform from '../filters/filter-transform';\nimport {NamedFilter, namedFilters} from '../filters/named-filter';\nimport ImageRecord from '../image-record';\nimport router from '../router';\nimport ViewState from '../view-state';\nimport View from './view';\n\nexport default class EditView extends View {\n  private destElement: HTMLCanvasElement;\n  private sourceElement: HTMLImageElement | null;\n  private closeButton: HTMLButtonElement;\n  private acceptButton: HTMLButtonElement;\n  private sliders: Map<string, HTMLInputElement>;\n  private effectButtons: Set<HTMLButtonElement>;\n  private filterSectionButton: HTMLButtonElement;\n  private tuneSectionButton: HTMLButtonElement;\n  private filterSection: HTMLDivElement;\n  private tuneSection: HTMLDivElement;\n  private animationFrame: number;\n  private currentRecord: ImageRecord | null;\n  private currentPanel: Element | null;\n  private transform: FilterTransform;\n\n  constructor() {\n    super(document.getElementById('edit-view')!);\n\n    this.destElement = document.getElementById('edit-dest')! as HTMLCanvasElement;\n    this.closeButton = document.getElementById('edit-view-close')! as HTMLButtonElement;\n    this.acceptButton = document.getElementById('edit-view-accept')! as HTMLButtonElement;\n    this.filterSectionButton = document.getElementById('edit-select-filters')! as HTMLButtonElement;\n    this.tuneSectionButton = document.getElementById('edit-select-tuning')! as HTMLButtonElement;\n    this.filterSection = document.getElementById('edit-filter')! as HTMLDivElement;\n    this.tuneSection = document.getElementById('edit-tune')! as HTMLDivElement;\n\n    this.closeButton.addEventListener('click', () => this.closeClick());\n    this.acceptButton.addEventListener('click', () => this.acceptClick());\n    this.filterSectionButton.addEventListener('click', () => this.toggleSection());\n    this.tuneSectionButton.addEventListener('click', () => this.toggleSection());\n\n    this.transform = new FilterTransform();\n\n    this.sliders = new Map();\n\n    const sliderElements = this.viewElement.getElementsByTagName('input');\n\n    for (const slider of Array.from(sliderElements)) {\n      this.sliders.set(slider.id, slider);\n\n      slider.addEventListener('input', () => {\n        this.transform[slider.id] = Number(slider.value) / 50;\n        if (!this.animationFrame) {\n          this.animationFrame = requestAnimationFrame(() => this.draw());\n        }\n      });\n    }\n\n    for (const filter of namedFilters) {\n      filter.values.randomize();\n\n      const button = document.createElement('button');\n      button.classList.add('filter-button');\n      button.id = `filter-button-${filter.name.toLowerCase()}`;\n      button.setAttribute('aria-label', filter.name);\n      button.tabIndex = 0;\n      button.addEventListener('click', () => this.filterButtonClick(filter));\n\n      const canvas = document.createElement('canvas');\n      canvas.classList.add('filter-thumbnail');\n      button.appendChild(canvas);\n\n      this.filterSection.appendChild(button);\n    }\n\n    this.effectButtons = new Set(this.viewElement.querySelectorAll('button.effect-button')) as Set<HTMLButtonElement>;\n\n    for (const effectButton of this.effectButtons) {\n      effectButton.addEventListener('click', () => this.effectButtonClick(effectButton));\n    }\n\n    this.sourceElement = null;\n\n    this.currentPanel = null;\n    this.currentRecord = null;\n  }\n\n  async show() {\n    const state = this.getState();\n\n    this.setTransform(state.transform || new FilterTransform());\n\n    if (!state.id) {\n      // TODO: Better handling of errors?\n      throw new Error(`Couldn't get id of image`);\n    }\n\n    const record: ImageRecord = await ImageRecord.fromDatabase(state.id);\n    this.currentRecord = record;\n    this.setTransform(record.transform || new FilterTransform());\n    const blob = await record.getOriginal();\n\n    const source = document.createElement('img');\n    this.sourceElement = source;\n    source.onload = () => {\n      URL.revokeObjectURL(source.src);\n      this.transform.apply(source, this.destElement);\n      this.animationFrame = requestAnimationFrame(() => this.draw());\n      this.renderThumbnails();\n    };\n    source.src = URL.createObjectURL(blob);\n    super.show();\n  }\n\n  hide() {\n    cancelAnimationFrame(this.animationFrame);\n    this.sourceElement = null;\n    this.animationFrame = 0;\n    this.currentRecord = null;\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n    }\n    super.hide();\n  }\n\n  getState(): ViewState {\n    const state = super.getState();\n    state.transform = state.transform || new FilterTransform();\n    return state;\n  }\n\n  setState(state: ViewState) {\n    if (state.transform) {\n      this.setTransform(state.transform);\n    }\n    super.setState(state);\n  }\n\n  private renderThumbnails() {\n    if (!this.sourceElement) {\n      return;\n    }\n\n    for (const filter of namedFilters) {\n      const output =\n        document.querySelector(`#filter-button-${filter.name.toLowerCase()} .filter-thumbnail`) as HTMLCanvasElement;\n      if (!output) {\n        console.error(`No output thumbnail for filter ${filter.name}`);\n      } else {\n        setTimeout(() => {\n          filter.values.apply(this.sourceElement!, output, 100);\n        }, 0);\n      }\n    }\n  }\n\n  private setTransform(transform: FilterTransform | {[name: string]: number}) {\n    if (transform instanceof FilterTransform) {\n      this.transform = transform;\n    } else {\n      for (const name of Object.getOwnPropertyNames(this.transform)) {\n        if (transform[name]) {\n          this.transform[name] = transform[name];\n        }\n      }\n    }\n    for (const [id, slider] of this.sliders) {\n      slider.value = String(this.transform[id] * 50);\n    }\n  }\n\n  private draw() {\n    if (this.sourceElement) {\n      this.transform.apply(this.sourceElement, this.destElement);\n    }\n\n    this.animationFrame = 0;\n  }\n\n  private filterButtonClick(filter: NamedFilter) {\n    this.setTransform(filter.values);\n\n    if (!this.animationFrame) {\n      this.animationFrame = requestAnimationFrame(() => this.draw());\n    }\n  }\n\n  private effectButtonClick(button: HTMLButtonElement) {\n    const panel = this.viewElement.querySelector(`#${button.id}-panel`)!;\n\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n\n      if (this.currentPanel !== panel) {\n        this.currentPanel = panel;\n        panel.classList.remove('hidden');\n      } else {\n        this.currentPanel = null;\n      }\n    } else {\n      this.currentPanel = panel;\n      panel.classList.remove('hidden');\n    }\n  }\n\n  private toggleSection() {\n    this.filterSection.classList.toggle('selected');\n    this.tuneSection.classList.toggle('selected');\n    this.filterSectionButton.classList.toggle('selected');\n    this.tuneSectionButton.classList.toggle('selected');\n    if (this.currentPanel) {\n      this.currentPanel.classList.add('hidden');\n      this.currentPanel = null;\n    }\n  }\n\n  private async save(): Promise<void> {\n    if (this.currentRecord) {\n      this.currentRecord.transform = this.transform;\n      this.currentRecord.save();\n    }\n  }\n\n  private closeClick() {\n    router.visit(`/browse`);\n  }\n\n  private acceptClick() {\n    this.save().then(() => {\n      router.visit(`/browse`);\n    });\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport ImageRecord from '../image-record';\nimport router from '../router';\nimport View from './view';\n\nexport default class UploadView extends View {\n  private uploadInput: HTMLInputElement;\n  private uploadButton: HTMLButtonElement;\n  private uploadDropTarget: HTMLDivElement;\n  private closeButton: HTMLButtonElement;\n\n  constructor() {\n    super(document.getElementById('upload-view')!);\n\n    this.uploadInput = document.getElementById('upload-file-input')! as HTMLInputElement;\n    this.uploadButton = document.getElementById('upload-button')! as HTMLButtonElement;\n    this.uploadDropTarget = document.getElementById('upload-drop-target')! as HTMLDivElement;\n    this.closeButton = document.getElementById('upload-view-close')! as HTMLButtonElement;\n\n    this.uploadInput.addEventListener('change', () => this.inputChange());\n    this.uploadButton.addEventListener('click', () => this.triggerUpload());\n    this.uploadDropTarget.addEventListener('drop', (e) => this.dropHandler(e));\n    this.uploadDropTarget.addEventListener('dragover', (e) => this.dragOverHandler(e));\n    this.closeButton.addEventListener('click', () => this.close());\n  }\n\n  inputChange() {\n    this.ingest(this.uploadInput.files!);\n  }\n\n  triggerUpload() {\n    this.uploadInput.click();\n  }\n\n  dragOverHandler(e: DragEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n    e.dataTransfer.dropEffect = 'copy';\n  }\n\n  dropHandler(e: DragEvent) {\n    e.stopPropagation();\n    e.preventDefault();\n\n    this.ingest(e.dataTransfer.files);\n  }\n\n  async ingest(files: FileList) {\n    if (files.length === 0) {\n      return;\n    }\n    const file = files[0];\n    const record = new ImageRecord();\n    record.setOriginal(file);\n    await record.save();\n    router.visit(`/edit/${record.id}`);\n  }\n\n  close() {\n    router.visit(`/browse`);\n  }\n}\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport {validate} from './sync/auth';\nimport ViewState from './view-state';\nimport BrowseView from './views/browse-view';\nimport CaptureView from './views/capture-view';\nimport EditView from './views/edit-view';\nimport UploadView from './views/upload-view';\nimport View from './views/view';\n\nclass Router {\n  private currentView: View | null;\n  private currentLocation: string;\n\n  private browseView: BrowseView;\n  private captureView: CaptureView;\n  private editView: EditView;\n  private uploadView: UploadView;\n\n  constructor() {\n    window.addEventListener('popstate', (e) => this.changeHandler(e.state));\n\n    this.browseView = new BrowseView();\n    this.captureView = new CaptureView();\n    this.editView = new EditView();\n    this.uploadView = new UploadView();\n  }\n\n  changeHandler(state?: ViewState) {\n    // TODO: Not sure that I should take the state here\n\n    // Ignore any changes in the hash.\n    if (window.location.pathname === this.currentLocation) {\n      return;\n    }\n    this.currentLocation = window.location.pathname;\n\n    const parts = this.currentLocation.split('/');\n\n    if (this.currentView) {\n      this.currentView.hide();\n    }\n\n    if (!state) {\n      state = new ViewState();\n    }\n\n    let newView: View | null = null;\n\n    switch (parts[1]) {\n      case 'capture':\n        newView = this.captureView;\n        break;\n      case '': // Entry point\n      case 'browse':\n        newView = this.browseView;\n        break;\n      case 'edit':\n        newView = this.editView;\n        state.id = Number(parts[2]);\n        break;\n      case 'upload':\n        newView = this.uploadView;\n        break;\n      case 'oauth':\n        this.handleOAuth().then(() => {\n          this.visit('/');\n        });\n        return;\n      default:\n        // TODO: Proper 404\n        console.log('404');\n    }\n\n    if (newView) {\n      this.switch(newView, state);\n    } else {\n      // TODO: Something better?\n      console.log('Oh no, no view found!');\n    }\n  }\n\n  switch(newView: View, state: ViewState) {\n    if (this.currentView) {\n      this.currentView.hide();\n    }\n    newView.setState(state);\n    newView.show();\n    this.currentView = newView;\n  }\n\n  visit(url: string) {\n    if (window.location.href === url) {\n      return;\n    }\n\n    let state;\n\n    if (this.currentView) {\n      state = this.currentView.getState();\n    }\n\n    window.history.replaceState(state, '', window.location.href);\n    window.history.pushState(null, '', url);\n    this.changeHandler();\n  }\n\n  click(event: MouseEvent) {\n    const anchor = event.target as HTMLAnchorElement;\n\n    if (event.metaKey || event.ctrlKey || event.button !== 0) {\n      return;\n    }\n\n    event.preventDefault();\n    this.visit(anchor.href);\n  }\n\n  handleOAuth() {\n    const hash = window.location.hash;\n    const parts = hash.substring(1).split('&');\n    let accessToken = '';\n\n    for (const part of parts) {\n      const [key, value] = part.split('=');\n      if (key === 'access_token') {\n        accessToken = value;\n      }\n    }\n    return validate(accessToken);\n  }\n}\n\nexport default new Router();\n","/*\n  Copyright 2017 Google Inc. All Rights Reserved.\n  Licensed under the Apache License, Version 2.0 (the \"License\");\n  you may not use this file except in compliance with the License.\n  You may obtain a copy of the License at\n      http://www.apache.org/licenses/LICENSE-2.0\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\n\nimport router from './router';\nimport {resume} from './sync/auth';\n\nif ('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js');\n}\n\nrouter.changeHandler();\n\nresume();\n"],"names":["CLIENT_ID","DRIVE_FOLDER","IMAGE_TYPE","SUPPORTS_BGSYNC","self","SUPPORTS_IMAGE_CAPTURE","SUPPORTS_MEDIA_DEVICES","navigator","SYNC_FREQUENCY","atob","split","Uint8Array","length","charCodeAt","buffer","toBlob","Promise","toDataURL","dataUrlToArrayBuffer","Blob","type","FileReader","addEventListener","result","readAsArrayBuffer","DB_VERSION","constructor","indexedDB","open","dbPromise","dbResolve","dbReject","onerror","onupgradeneeded","createObjectStore","onsuccess","dbOpened","storeRecord","id","then","transaction","objectStore","put","catch","retrieveRecord","get","deleteRecord","delete","oncomplete","storeMedia","blobToArrayBuffer","media","retrieveMedia","addSync","guid","removeSync","listSync","openCursor","push","value","continue","setMeta","getMeta","all","error","console","target","oldVersion","deleteObjectStore","autoIncrement","keyPath","imageDB","ImageDB","subscribers","Map","pubsub","publish","has","channel","log","size","subscribe","set","Set","add","unsubscribe","serviceWorker","data","user","User","Date","now","validate","URL","searchParams","append","constants","location","origin","window","replace","toString","token","fetch","ok","logout","json","aud","name","displayName","imageURL","image","url","tokenExpiry","exp","BASE_VERTEX_SHADER","BASE_FRAGMENT_SHADER","POSITIONS","Float32Array","UVS","INDEX","Uint16Array","canvas","document","createElement","getContext","Error","context","createTexture","textureId","programId","vertShader","fragShader","uniformLocations","bindBuffers","clearColor","dirtyProgram","setImage","activeTexture","TEXTURE0","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","setVertexShader","setFragmentShader","setUniform","createProgram","warn","FLOAT","uniform1fv","FLOAT_VEC2","uniform2fv","FLOAT_VEC3","uniform3fv","FLOAT_VEC4","uniform4fv","BOOL","INT","uniform1iv","BOOL_VEC2","INT_VEC2","uniform2iv","BOOL_VEC3","INT_VEC3","uniform3iv","BOOL_VEC4","INT_VEC4","uniform4iv","render","viewport","drawingBufferWidth","drawingBufferHeight","clear","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","drawElements","TRIANGLES","UNSIGNED_SHORT","flush","compileShader","VERTEX_SHADER","FRAGMENT_SHADER","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","validateProgram","VALIDATE_STATUS","useProgram","getUniformLocations","createShader","shaderSource","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","ACTIVE_UNIFORMS","getActiveUniform","getUniformLocation","bindIndicesBuffer","bindAttributeBuffer","enableVertexAttribArray","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","vertexAttribPointer","ELEMENT_ARRAY_BUFFER","shader","ImageShader","fragmentShader","random","Math","from","FilterTransform","saturation","warmth","sharpen","blur","brightness","contrast","grey","vignette","randomize","apply","HTMLImageElement","naturalWidth","naturalHeight","HTMLVideoElement","videoWidth","videoHeight","width","height","devicePixelRatio","drawImage","ImageState","fromDatabase","ImageRecord","fromListRecord","originalState","NOT_LOADED","editedState","thumbnailState","originalId","editedId","thumbnailId","transform","localImageChanges","localFilterChanges","lastSyncVersion","getAll","CHANGED","$transform","originalCache","editedCache","thumbnailCache","OUT_OF_DATE","getOriginal","LOADED","getEdited","drawFiltered","getThumbnail","setOriginal","onload","revokeObjectURL","src","canvasToBlob","createObjectURL","save","DRIVE_API","DRIVE_UPLOAD_API","COMMON_FILE_FIELDS","status","statusText","makeURL","access_token","doFetch","alt","blob","uploadType","method","body","driveMediaRequest","driveRequest","fields","JSON","stringify","headers","appProperties","mimeType","driveUploadRequest","corpus","q","spaces","nextPageToken","concat","files","snapshotFolder","ChangeType","syncFiles","setInterval","syncStart","parents","createFileMeta","getRegistration","getSnapshotFolder","folderList","values","trashed","upload","includeMedia","REMOVE","deleteLocal","version","sync","register","downloadRemote","uploadLocal","getFileContent","ADD","updateFileMeta","updateFileContent","viewElement","show","classList","remove","hide","getState","state","ViewState","setState","View","getElementById","captureButton","uploadButton","loginButton","logoutButton","loginBar","userName","userImage","emptyListElement","listElement","captureClick","uploadClick","loginClick","logoutClick","thumbnails","blobURLs","authChanged","syncHandler","addThumbnail","setListVisibility","hasChildNodes","removeChild","lastChild","router","visit","login","innerText","appendChild","UPDATE","streamConstraints","video","deviceId","facingMode","ideal","supportedConstraints","mediaDevices","getSupportedConstraints","stream","track","photoCapabilities","trackConstraints","flash","getCameras","enumerateDevices","filter","kind","takePhoto","srcObject","getVideoTracks","ImageCapture","fillLightMode","includes","stopStream","stop","startStream","getUserMedia","getPhotoCapabilities","redEyeReduction","getSettings","videoElement","querySelector","videoElement2","takePhotoButton","cameraChooseButton","mirrorButton","flashButton","closeButton","cameraHelper","CameraHelper","toggleCameraChooser","toggleMirror","toggleFlash","close","devicesPromise","getDevices","currentDevice","chooseCamera","pause","storeResult","indexOf","onloadedmetadata","play","toggle","namedFilters","destElement","acceptButton","filterSectionButton","tuneSectionButton","filterSection","tuneSection","closeClick","acceptClick","toggleSection","sliders","getElementsByTagName","Array","animationFrame","requestAnimationFrame","draw","toLowerCase","setAttribute","tabIndex","filterButtonClick","effectButtons","querySelectorAll","effectButtonClick","sourceElement","currentPanel","currentRecord","setTransform","renderThumbnails","cancelAnimationFrame","setTimeout","Object","getOwnPropertyNames","uploadInput","uploadDropTarget","inputChange","triggerUpload","dropHandler","dragOverHandler","ingest","click","stopPropagation","preventDefault","dataTransfer","dropEffect","changeHandler","browseView","BrowseView","captureView","CaptureView","editView","EditView","uploadView","UploadView","pathname","currentLocation","currentView","handleOAuth","switch","href","history","replaceState","pushState","metaKey","ctrlKey","button","hash","substring","Router","resume"],"mappings":"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"}